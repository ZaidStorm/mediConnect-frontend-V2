<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Doctor Appointments</title>
  <link href="../css/doctor_appointments.css" rel="stylesheet">
</head>
<body>

<header class="topbar">
  <h1>Today's Appointments & Reports</h1>
</header>

<div class="container mt-4">
  <ul class="nav nav-tabs mb-3" id="doctorTabs" role="tablist">
    <li class="nav-item"><a class="nav-link active" id="appointments-tab" data-bs-toggle="tab" href="#appointments">Appointments</a></li>
    <li class="nav-item"><a class="nav-link" id="reports-tab" data-bs-toggle="tab" href="#reports">Patient Reports</a></li>
  </ul>

  <div class="tab-content">
    <!-- Appointments Tab -->
    <div class="tab-pane fade show active" id="appointments">
      <div class="card p-3">
        <table class="table">
          <thead>
            <tr><th>Name</th><th>Patient ID</th><th>Phone</th><th>Doctor</th><th>Date</th><th>Time</th><th>Action</th></tr>
          </thead>
          <tbody id="doctorInbox"></tbody>
        </table>
      </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-pane fade" id="reports">
      <div class="row" id="doctorReportSection"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function renderDoctorInbox() {
    const tbody = document.getElementById('doctorInbox');
    const inbox = JSON.parse(localStorage.getItem('doctorInbox') || '[]');
    tbody.innerHTML = '';
    inbox.forEach((item, idx) => {
      const tr = document.createElement('tr');
      const patientId = item.patientId || 'N/A';
      tr.innerHTML = `
        <td>${item.name}</td>
        <td><strong>${patientId}</strong></td>
        <td>${item.phone}</td>
        <td>${item.doctor}</td>
        <td>${item.date}</td>
        <td>${item.time}</td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="openInPrescription(${idx})">Prescription</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function openInPrescription(index) {
    const inbox = JSON.parse(localStorage.getItem('doctorInbox') || '[]');
    const item = inbox[index];
    if (!item) return alert('No appointment found');

    const draft = {
      name: item.name,
      age: item.age || '',
      gender: item.gender || '',
      date: item.date,
      patientId: item.patientId || 'N/A',
      diagnosis: '',
      meds: '',
      labs: ''
    };
    localStorage.setItem('prescriptionDraft', JSON.stringify(draft));
    window.location.href = 'prescription.html';
  }

  function renderDoctorReports() {
    const container = document.getElementById('doctorReportSection');
    const doctorReports = JSON.parse(localStorage.getItem('doctorReports') || '[]');
    container.innerHTML = '';

    if (!doctorReports.length) {
      container.innerHTML = '<div class="col-12"><p class="text-muted">No reports sent yet.</p></div>';
      return;
    }

    doctorReports.forEach(pkg => {
      const col = document.createElement('div');
      col.className = 'col-md-4 mb-3';

      let reportHtml = '';
      pkg.reports.forEach(report => {
        reportHtml += `
          <div class="report-item mb-2">
            <img src="${report.image}" style="height: 100px; object-fit: cover; border-radius: 4px; cursor: pointer;" onclick="openModal('${report.image}')">
            <small>${report.category}</small>
          </div>
        `;
      });

      col.innerHTML = `
        <div class="patient-report-card p-3 border rounded" style="background: #f0f8ff;">
          <h5>${pkg.patientName} (${pkg.patientId})</h5>
          <small>Reports: ${pkg.reports.length}</small>
          <div class="mt-2" style="max-height: 250px; overflow-y: auto;">
            ${reportHtml}
          </div>
          <button class="btn btn-sm btn-success mt-3 w-100" onclick="openPatientPrescriptions('${pkg.patientId}')">View Prescription</button>
        </div>
      `;
      container.appendChild(col);
    });
  }

  function openPatientPrescriptions(patientId) {
    // Get inbox for this patient
    const inbox = JSON.parse(localStorage.getItem('doctorInbox') || '[]');
    const patientAppts = inbox.filter(a => a.patientId === patientId);
    if (!patientAppts.length) return alert('No appointments for this patient');

    const item = patientAppts[0];
    const draft = {
      name: item.name,
      age: item.age || '',
      gender: item.gender || '',
      date: item.date,
      patientId: patientId,
      diagnosis: '',
      meds: '',
      labs: ''
    };
    localStorage.setItem('prescriptionDraft', JSON.stringify(draft));
    window.location.href = 'prescription.html';
  }

  function openModal(src) {
    let modal = document.getElementById('imageModal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'imageModal';
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content text-center">
          <span class="modal-close" onclick="closeModal()">Ã—</span>
          <img id="modalImage" style="max-width:100%; max-height:400px;">
        </div>
      `;
      document.body.appendChild(modal);
    }
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').style.display = 'flex';
  }

  function closeModal() {
    const modal = document.getElementById('imageModal');
    if (modal) modal.style.display = 'none';
  }

  document.addEventListener('DOMContentLoaded', () => {
    renderDoctorInbox();
    renderDoctorReports();
  });
</script>

</body>
</html>
